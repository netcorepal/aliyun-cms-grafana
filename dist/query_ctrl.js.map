{"version":3,"sources":["../src/query_ctrl.js"],"names":["QueryCtrl","GenericDatasourceQueryCtrl","$scope","$injector","scope","target","type","ycol","describe","xcol","project","metric","period","group","dimensions","statistics","query","checkIsNull","datasource","metricFindQuery","getProject","getMetrics","getPeriod","getStatistics","_","includes","push","panelCtrl","refresh","i","indexOf","splice","getGroups","getDimensions","dimension","rawQuery","re","RegExp","test","templateUrl"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAQA,e,kBAAAA,S;;;;;;;;;;;;;;;;;;;;;4CAGKC,0B;;;AAEX,4CAAYC,MAAZ,EAAoBC,SAApB,EAAgC;AAAA;;AAAA,8JACxBD,MADwB,EAChBC,SADgB;;AAE9B,gBAAKC,KAAL,GAAaF,MAAb;AACA,gBAAKG,MAAL,CAAYC,IAAZ,GAAmB,MAAKD,MAAL,CAAYC,IAAZ,IAAoB,WAAvC;AACA,gBAAKD,MAAL,CAAYA,MAAZ,GAAqB,MAAKA,MAAL,CAAYE,IAAjC;AACA,gBAAKF,MAAL,CAAYG,QAAZ,GAAuB,MAAKH,MAAL,CAAYG,QAAnC;AACA,gBAAKH,MAAL,CAAYI,IAAZ,GAAmB,MAAKJ,MAAL,CAAYI,IAAZ,IAAoB,WAAvC;AACA,gBAAKJ,MAAL,CAAYK,OAAZ,GAAsB,MAAKL,MAAL,CAAYK,OAAZ,IAAuB,mBAA7C;AACA,gBAAKL,MAAL,CAAYM,MAAZ,GAAqB,MAAKN,MAAL,CAAYM,MAAjC;AACA,gBAAKN,MAAL,CAAYO,MAAZ,GAAqB,MAAKP,MAAL,CAAYO,MAAjC;AACA,gBAAKP,MAAL,CAAYQ,KAAZ,GAAoB,MAAKR,MAAL,CAAYQ,KAAhC;AACA,gBAAKR,MAAL,CAAYS,UAAZ,GAAyB,MAAKT,MAAL,CAAYS,UAAZ,IAA0B,EAAnD;AACA,gBAAKA,UAAL;;AAEA,gBAAKT,MAAL,CAAYE,IAAZ,GAAmB,MAAKF,MAAL,CAAYE,IAAZ,IAAoB,EAAvC;AACA,gBAAKQ,UAAL;;AAf8B;AAiB/B;;;;qCAEUC,K,EAAO;AAChB,iBAAKC,WAAL;AACA,mBAAO,KAAKC,UAAL,CAAgBC,eAAhB,CAAgCH,SAAS,EAAzC,CAAP;AACD;;;wCAEa;AACZ,iBAAKC,WAAL;AACA,mBAAO,KAAKC,UAAL,CAAgBE,UAAhB,EAAP;AACD;;;uCAEY;AACX,iBAAKH,WAAL;AACA,gBAAG,KAAKZ,MAAL,CAAYK,OAAf,EAAuB;AACrB,qBAAO,KAAKQ,UAAL,CAAgBG,UAAhB,CAA2B,KAAKhB,MAAL,CAAYK,OAAvC,CAAP;AACD;AACF;;;sCAEW;AACV,iBAAKO,WAAL;AACA,gBAAG,KAAKZ,MAAL,CAAYK,OAAZ,IAAuB,KAAKL,MAAL,CAAYM,MAAtC,EAA6C;AAC3C,qBAAO,KAAKO,UAAL,CAAgBI,SAAhB,CAA0B,KAAKjB,MAAL,CAAYK,OAAtC,EAA8C,KAAKL,MAAL,CAAYM,MAA1D,CAAP;AACD;AACF;;;0CAEe;AACd,iBAAKM,WAAL;AACA,gBAAG,KAAKZ,MAAL,CAAYK,OAAZ,IAAuB,KAAKL,MAAL,CAAYM,MAAtC,EAA6C;AAC3C,qBAAO,KAAKO,UAAL,CAAgBK,aAAhB,CAA8B,KAAKlB,MAAL,CAAYK,OAA1C,EAAkD,KAAKL,MAAL,CAAYM,MAA9D,EAAqE,KAAKN,MAAL,CAAYE,IAAjF,CAAP;AACD;AACF;;;mCAEQA,I,EAAK;AACZ,iBAAKU,WAAL;AACA,gBAAG,CAACV,IAAD,IAASiB,EAAEC,QAAF,CAAW,KAAKpB,MAAL,CAAYE,IAAvB,EAA6BA,IAA7B,CAAZ,EAAgD;AAC5C;AACH;AACD,iBAAKF,MAAL,CAAYE,IAAZ,CAAiBmB,IAAjB,CAAsBnB,IAAtB;AACA,iBAAKQ,UAAL,GAAkB,EAAlB;AACA,iBAAKY,SAAL,CAAeC,OAAf;AACD;;;qCAEUrB,I,EAAK;AACd,iBAAKU,WAAL;AACA,gBAAG,CAACV,IAAD,IAAS,CAACiB,EAAEC,QAAF,CAAW,KAAKpB,MAAL,CAAYE,IAAvB,EAA6BA,IAA7B,CAAb,EAAiD;AAC7C;AACH;AACD,gBAAIsB,IAAI,KAAKxB,MAAL,CAAYE,IAAZ,CAAiBuB,OAAjB,CAAyBvB,IAAzB,CAAR;AACA,iBAAKF,MAAL,CAAYE,IAAZ,CAAiBwB,MAAjB,CAAwBF,CAAxB,EAA0B,CAA1B;AACA,iBAAKd,UAAL,GAAkB,EAAlB;AACA,iBAAKY,SAAL,CAAeC,OAAf;AACD;;;sCAEW;AACV,iBAAKX,WAAL;AACA,mBAAO,KAAKC,UAAL,CAAgBc,SAAhB,EAAP;AACD;;;0CAEe;AACd,iBAAKf,WAAL;AACA,gBAAG,KAAKZ,MAAL,CAAYK,OAAZ,IAAuB,KAAKL,MAAL,CAAYM,MAAtC,EAA6C;AAC3C,qBAAO,KAAKO,UAAL,CAAgBe,aAAhB,CAA8B,KAAK5B,MAAL,CAAYK,OAA1C,EAAkD,KAAKL,MAAL,CAAYM,MAA9D,EAAqE,KAAKN,MAAL,CAAYQ,KAAjF,EAAuF,KAAKR,MAAL,CAAYS,UAAnG,EAA8G,KAAKT,MAAL,CAAYO,MAA1H,CAAP;AACD;AACF;;;yCAEcsB,S,EAAU;AACvB,iBAAKjB,WAAL;AACA,gBAAG,CAACiB,SAAD,IAAcV,EAAEC,QAAF,CAAW,KAAKpB,MAAL,CAAYS,UAAvB,EAAmCoB,SAAnC,CAAjB,EAAgE;AAC5D;AACH;AACD,iBAAK7B,MAAL,CAAYS,UAAZ,CAAuBY,IAAvB,CAA4BQ,SAA5B;AACA,iBAAKpB,UAAL,GAAkB,EAAlB;AACA,iBAAKa,SAAL,CAAeC,OAAf;AACD;;;2CAEgBM,S,EAAU;AACzB,iBAAKjB,WAAL;AACA,gBAAG,CAACiB,SAAD,IAAc,CAACV,EAAEC,QAAF,CAAW,KAAKpB,MAAL,CAAYS,UAAvB,EAAmCoB,SAAnC,CAAlB,EAAiE;AAC7D;AACH;AACD,gBAAIL,IAAI,KAAKxB,MAAL,CAAYS,UAAZ,CAAuBgB,OAAvB,CAA+BI,SAA/B,CAAR;AACA,iBAAK7B,MAAL,CAAYS,UAAZ,CAAuBiB,MAAvB,CAA8BF,CAA9B,EAAgC,CAAhC;AACA,iBAAKf,UAAL,GAAkB,EAAlB;AACA,iBAAKa,SAAL,CAAeC,OAAf;AACD;;;6CAEkB;AACjB,iBAAKvB,MAAL,CAAY8B,QAAZ,GAAuB,CAAC,KAAK9B,MAAL,CAAY8B,QAApC;AACD;;;6CAEkB;AACjB,iBAAKlB,WAAL;AACA,iBAAKU,SAAL,CAAeC,OAAf,GAFiB,CAES;AAC3B;;;wCAGY;AACX,gBAAIQ,KAAK,IAAIC,MAAJ,CAAW,QAAX,CAAT;AACA,gBAAG,CAAC,KAAKhC,MAAL,CAAYK,OAAb,IAAwB,KAAKL,MAAL,CAAYK,OAAZ,IAAuB,MAA/C,IACE,KAAKL,MAAL,CAAYK,OAAZ,IAAuB,GADzB,IACgC,KAAKL,MAAL,CAAYK,OAAZ,IAAuB,IADvD,IAEE0B,GAAGE,IAAH,CAAQ,KAAKjC,MAAL,CAAYK,OAApB,CAFL,EAEkC;AAChC,mBAAKL,MAAL,CAAYK,OAAZ,GAAsB,EAAtB;AACD;AACD,gBAAG,CAAC,KAAKL,MAAL,CAAYM,MAAb,IAAuB,KAAKN,MAAL,CAAYM,MAAZ,IAAsB,MAA7C,IACE,KAAKN,MAAL,CAAYM,MAAZ,IAAsB,GADxB,IAC+B,KAAKN,MAAL,CAAYM,MAAZ,IAAsB,IADrD,IAEEyB,GAAGE,IAAH,CAAQ,KAAKjC,MAAL,CAAYM,MAApB,CAFL,EAEiC;AAC/B,mBAAKN,MAAL,CAAYM,MAAZ,GAAqB,EAArB;AACD;AACD,gBAAG,CAAC,KAAKN,MAAL,CAAYO,MAAb,IAAuB,KAAKP,MAAL,CAAYO,MAAZ,IAAsB,MAA7C,IACE,KAAKP,MAAL,CAAYO,MAAZ,IAAsB,GADxB,IAC+B,KAAKP,MAAL,CAAYO,MAAZ,IAAsB,IADrD,IAEEwB,GAAGE,IAAH,CAAQ,KAAKjC,MAAL,CAAYO,MAApB,CAFL,EAEiC;AAC/B,mBAAKP,MAAL,CAAYO,MAAZ,GAAqB,EAArB;AACD;AACD,gBAAG,CAAC,KAAKP,MAAL,CAAYQ,KAAb,IAAsB,KAAKR,MAAL,CAAYQ,KAAZ,IAAqB,MAA3C,IACE,KAAKR,MAAL,CAAYQ,KAAZ,IAAqB,GADvB,IAC8B,KAAKR,MAAL,CAAYQ,KAAZ,IAAqB,IADnD,IAEEuB,GAAGE,IAAH,CAAQ,KAAKjC,MAAL,CAAYQ,KAApB,CAFL,EAEgC;AAC9B,mBAAKR,MAAL,CAAYQ,KAAZ,GAAoB,EAApB;AACD;AACD,gBAAG,CAAC,KAAKR,MAAL,CAAYS,UAAb,IAA2B,KAAKT,MAAL,CAAYS,UAAZ,IAA0B,MAArD,IACE,KAAKT,MAAL,CAAYS,UAAZ,IAA0B,GAD5B,IACmC,KAAKT,MAAL,CAAYS,UAAZ,IAA0B,IAD7D,IAEEsB,GAAGE,IAAH,CAAQ,KAAKjC,MAAL,CAAYS,UAApB,CAFL,EAEqC;AACnC,mBAAKT,MAAL,CAAYS,UAAZ,GAAyB,EAAzB;AACD;AACD,gBAAG,CAAC,KAAKA,UAAN,IAAoB,KAAKA,UAAL,IAAmB,MAAvC,IACE,KAAKA,UAAL,IAAmB,GADrB,IAC4B,KAAKA,UAAL,IAAmB,IAD/C,IAEEsB,GAAGE,IAAH,CAAQ,KAAKxB,UAAb,CAFL,EAE8B;AAC5B,mBAAKA,UAAL,GAAkB,EAAlB;AACD;AACD,gBAAG,CAAC,KAAKT,MAAL,CAAYE,IAAb,IAAqB,KAAKF,MAAL,CAAYE,IAAZ,IAAoB,MAAzC,IACE,KAAKF,MAAL,CAAYE,IAAZ,IAAoB,GADtB,IAC6B,KAAKF,MAAL,CAAYE,IAAZ,IAAoB,IADjD,IAEE6B,GAAGE,IAAH,CAAQ,KAAKjC,MAAL,CAAYE,IAApB,CAFL,EAE+B;AAC7B,mBAAKF,MAAL,CAAYE,IAAZ,GAAmB,EAAnB;AACD;AACD,gBAAG,CAAC,KAAKQ,UAAN,IAAoB,KAAKA,UAAL,IAAmB,MAAvC,IACE,KAAKA,UAAL,IAAmB,GADrB,IAC4B,KAAKA,UAAL,IAAmB,IAD/C,IAEEqB,GAAGE,IAAH,CAAQ,KAAKvB,UAAb,CAFL,EAE8B;AAC5B,mBAAKA,UAAL,GAAkB,EAAlB;AACD;AACD,gBAAG,CAAC,KAAKV,MAAL,CAAYI,IAAb,IAAqB,KAAKJ,MAAL,CAAYI,IAAZ,IAAoB,MAAzC,IACE,KAAKJ,MAAL,CAAYI,IAAZ,IAAoB,GADtB,IAC6B,KAAKJ,MAAL,CAAYI,IAAZ,IAAoB,IADjD,IAEE2B,GAAGE,IAAH,CAAQ,KAAKjC,MAAL,CAAYI,IAApB,CAFL,EAE+B;AAC7B,mBAAKJ,MAAL,CAAYI,IAAZ,GAAmB,EAAnB;AACD;AACD,gBAAG,CAAC,KAAKJ,MAAL,CAAYG,QAAb,IAAyB,KAAKH,MAAL,CAAYG,QAAZ,IAAwB,MAAjD,IACE,KAAKH,MAAL,CAAYG,QAAZ,IAAwB,GAD1B,IACiC,KAAKH,MAAL,CAAYG,QAAZ,IAAwB,IADzD,IAEE4B,GAAGE,IAAH,CAAQ,KAAKjC,MAAL,CAAYG,QAApB,CAFL,EAEmC;AACjC,mBAAKH,MAAL,CAAYG,QAAZ,GAAuB,EAAvB;AACD;AACF;;;;QAxK6CR,S;;;;AA2KhDC,iCAA2BsC,WAA3B,GAAyC,4BAAzC","file":"query_ctrl.js","sourcesContent":["import {QueryCtrl} from 'app/plugins/sdk';\r\nimport './css/query-editor.css!'\r\n\r\nexport class GenericDatasourceQueryCtrl extends QueryCtrl {\r\n\r\n  constructor($scope, $injector)  {\r\n    super($scope, $injector);\r\n    this.scope = $scope;\r\n    this.target.type = this.target.type || 'timeserie';\r\n    this.target.target = this.target.ycol;\r\n    this.target.describe = this.target.describe;\r\n    this.target.xcol = this.target.xcol || 'timestamp';\r\n    this.target.project = this.target.project || 'acs_ecs_dashboard';\r\n    this.target.metric = this.target.metric;\r\n    this.target.period = this.target.period;\r\n    this.target.group = this.target.group;\r\n    this.target.dimensions = this.target.dimensions || [];\r\n    this.dimensions;\r\n    \r\n    this.target.ycol = this.target.ycol || [];\r\n    this.statistics;\r\n\r\n  }\r\n\r\n  getOptions(query) {\r\n    this.checkIsNull();\r\n    return this.datasource.metricFindQuery(query || '');\r\n  }\r\n\r\n  getProjects() {\r\n    this.checkIsNull();\r\n    return this.datasource.getProject();\r\n  }\r\n\r\n  getMetrics() {\r\n    this.checkIsNull();\r\n    if(this.target.project){\r\n      return this.datasource.getMetrics(this.target.project);\r\n    }\r\n  }\r\n\r\n  getPeriod() {\r\n    this.checkIsNull();\r\n    if(this.target.project && this.target.metric){\r\n      return this.datasource.getPeriod(this.target.project,this.target.metric);\r\n    }\r\n  }\r\n\r\n  getStatistics() {\r\n    this.checkIsNull();\r\n    if(this.target.project && this.target.metric){\r\n      return this.datasource.getStatistics(this.target.project,this.target.metric,this.target.ycol);\r\n    }\r\n  }\r\n\r\n  ycolPush(ycol){\r\n    this.checkIsNull();\r\n    if(!ycol || _.includes(this.target.ycol, ycol)) {\r\n        return;\r\n    }\r\n    this.target.ycol.push(ycol);\r\n    this.statistics = \"\";\r\n    this.panelCtrl.refresh();\r\n  }\r\n\r\n  ycolSplice(ycol){\r\n    this.checkIsNull();\r\n    if(!ycol || !_.includes(this.target.ycol, ycol)) {\r\n        return;\r\n    }\r\n    let i = this.target.ycol.indexOf(ycol)\r\n    this.target.ycol.splice(i,1);\r\n    this.statistics = \"\";\r\n    this.panelCtrl.refresh(); \r\n  }\r\n\r\n  getGroups() {\r\n    this.checkIsNull();\r\n    return this.datasource.getGroups();\r\n  }\r\n\r\n  getDimensions() {\r\n    this.checkIsNull();\r\n    if(this.target.project && this.target.metric){\r\n      return this.datasource.getDimensions(this.target.project,this.target.metric,this.target.group,this.target.dimensions,this.target.period);\r\n    }\r\n  }\r\n\r\n  dimensionsPush(dimension){\r\n    this.checkIsNull();\r\n    if(!dimension || _.includes(this.target.dimensions, dimension)) {\r\n        return;\r\n    }\r\n    this.target.dimensions.push(dimension);\r\n    this.dimensions = \"\";\r\n    this.panelCtrl.refresh();\r\n  }\r\n\r\n  dimensionsSplice(dimension){\r\n    this.checkIsNull();\r\n    if(!dimension || !_.includes(this.target.dimensions, dimension)) {\r\n        return;\r\n    }\r\n    let i = this.target.dimensions.indexOf(dimension)\r\n    this.target.dimensions.splice(i,1);\r\n    this.dimensions = \"\";\r\n    this.panelCtrl.refresh(); \r\n  }\r\n\r\n  toggleEditorMode() {\r\n    this.target.rawQuery = !this.target.rawQuery;\r\n  }\r\n\r\n  onChangeInternal() {\r\n    this.checkIsNull();\r\n    this.panelCtrl.refresh(); // Asks the panel to refresh data.\r\n  }\r\n  \r\n  // 校验页面可输入参数，防止脏乱\r\n  checkIsNull(){\r\n    var re = new RegExp(\"^[ ]+$\");\r\n    if(!this.target.project || this.target.project == \"null\" \r\n      || this.target.project == \" \" || this.target.project == '\"\"' \r\n      || re.test(this.target.project)){\r\n      this.target.project = \"\";\r\n    }\r\n    if(!this.target.metric || this.target.metric == \"null\" \r\n      || this.target.metric == \" \" || this.target.metric == '\"\"' \r\n      || re.test(this.target.metric)){\r\n      this.target.metric = \"\";\r\n    }\r\n    if(!this.target.period || this.target.period == \"null\" \r\n      || this.target.period == \" \" || this.target.period == '\"\"' \r\n      || re.test(this.target.period)){\r\n      this.target.period = \"\";\r\n    }\r\n    if(!this.target.group || this.target.group == \"null\" \r\n      || this.target.group == \" \" || this.target.group == '\"\"' \r\n      || re.test(this.target.group)){\r\n      this.target.group = \"\";\r\n    };\r\n    if(!this.target.dimensions || this.target.dimensions == \"null\" \r\n      || this.target.dimensions == \" \" || this.target.dimensions == '\"\"' \r\n      || re.test(this.target.dimensions)){\r\n      this.target.dimensions = \"\";\r\n    }\r\n    if(!this.dimensions || this.dimensions == \"null\" \r\n      || this.dimensions == \" \" || this.dimensions == '\"\"' \r\n      || re.test(this.dimensions)){\r\n      this.dimensions = \"\";\r\n    }\r\n    if(!this.target.ycol || this.target.ycol == \"null\" \r\n      || this.target.ycol == \" \" || this.target.ycol == '\"\"' \r\n      || re.test(this.target.ycol)){\r\n      this.target.ycol = \"\";\r\n    }\r\n    if(!this.statistics || this.statistics == \"null\" \r\n      || this.statistics == \" \" || this.statistics == '\"\"' \r\n      || re.test(this.statistics)){\r\n      this.statistics = \"\";\r\n    }\r\n    if(!this.target.xcol || this.target.xcol == \"null\" \r\n      || this.target.xcol == \" \" || this.target.xcol == '\"\"' \r\n      || re.test(this.target.xcol)){\r\n      this.target.xcol = \"\";\r\n    }\r\n    if(!this.target.describe || this.target.describe == \"null\" \r\n      || this.target.describe == \" \" || this.target.describe == '\"\"' \r\n      || re.test(this.target.describe)){\r\n      this.target.describe = \"\";\r\n    }\r\n  }\r\n}\r\n\r\nGenericDatasourceQueryCtrl.templateUrl = 'partials/query.editor.html';\r\n\r\n"]}