{"version":3,"sources":["../src/datasource.js"],"names":["_","CmsSigner","GenericDatasource","instanceSettings","$q","backendSrv","templateSrv","type","basePath","url","name","jsonData","q","headers","options","requests","promise","Promise","resolve","result","targets","forEach","target","project","metric","ycol","xcol","describe","query","dimensions","period","group","request","getDimensionsByGroup","getVariableValue","then","response","code","data","length","concat","JSON","stringify","indexOf","dimensionAcsJson","dimensionAcsObj","toString","replace","dimensionArray","dimensionJson","i","push","queryConcat","parseInt","range","from","_d","getTime","to","param","path","method","buildRealUrl","isEmpty","d","defer","datasourceRequest","status","Code","resResult","dataDatapoints","angular","fromJson","Datapoints","datapoints","ycolTarget","each","datapoint","Datapoint","parse","catch","error","console","log","all","map","p","e","variable","variables","find","intVar","current","value","isNaN","ErrorCode","Success","message","title","format","arr","instanceId","r","text","getProject","getGroups","pars","split","vb","signer","accessKeyId","cmsAccessKey","secretAccessKey","cmsSecretKey","addAuthorization","isObject","projectArray","Resources","Resource","projectInfo","Project","acs_param","projectAcsLog","UserId","projectAcsCustom","resource","resourceInfo","Metric","Periods","mapToTextValue","statistics","Statistics","groupInfo","GroupId","GroupName","instance","instanceInfo","InstanceId","includes","endTime","Date","startTime","datapointInfo","obj"],"mappings":"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","file":"datasource.js","sourcesContent":["import _ from \"lodash\";\r\nimport { CmsSigner } from \"./signer.js\";\r\n\r\nexport class GenericDatasource {\r\n  constructor(instanceSettings, $q, backendSrv, templateSrv) {\r\n    this.type = instanceSettings.type;\r\n    this.basePath = instanceSettings.url;\r\n    this.name = instanceSettings.name;\r\n    this.jsonData = instanceSettings.jsonData;\r\n    this.q = $q;\r\n    this.backendSrv = backendSrv;\r\n    this.templateSrv = templateSrv;\r\n    this.headers = { 'Content-Type': 'application/json' };\r\n  }\r\n\r\n  query(options) {\r\n    let requests = []\r\n    let promise = Promise.resolve();\r\n    var result = [];\r\n    _(options.targets).forEach(target => {\r\n      //非空参数判空处理\r\n      if (!target.project || !target.metric || !target.ycol || !target.xcol) {\r\n        return;\r\n      }\r\n      var project = target.project;\r\n      var metric = target.metric;\r\n      //默认数组\r\n      var ycol = target.ycol;\r\n      var xcol = target.xcol;\r\n      var describe = target.describe;\r\n      if (!describe) {\r\n        describe = '';\r\n      } else {\r\n        describe = describe + \".\";\r\n      }\r\n      var query = \"/?Action=QueryMetricList&Length=2000\";\r\n      var dimensions = \"\";\r\n      var period = target.period;\r\n      var group = target.group\r\n      if (!period) {\r\n        period = '';\r\n      }\r\n      if (!group) {\r\n        group = '';\r\n      }\r\n      //定义Promise元数据\r\n      let request = this.getDimensionsByGroup(this.getVariableValue(group),this.getVariableValue(project)).then(response => {\r\n        // console.log(JSON.stringify(response));\r\n        //处理group--根据GroupId获取该组下的所有实例Id\r\n        if ('200' == response.code && response.data.length > 0) {\r\n          var data = response.data;\r\n          dimensions = dimensions.concat(JSON.stringify(data));\r\n        } else {\r\n          dimensions = '';\r\n        }\r\n        //自定义监控(acs_custom)、日志监控(acs_logMonitor)自动取消分组功能\r\n        if (project.indexOf(\"acs_custom\") == -1 || project.indexOf(\"acs_logMonitor\") == -1) {\r\n          dimensions = '';\r\n        }\r\n      }).then(() => {\r\n        //GroupId存在的同时,dimensions存在,则dimensions覆盖Group下的所有实例Id，以dimensions为准\r\n        if (target.dimensions.length == 0) {\r\n          dimensions = dimensions;\r\n        } else {\r\n          //自定义监控(acs_custom)、日志监控(acs_logMonitor)处理\r\n          // console.log(project.indexOf(\"acs_custom\") == -1);\r\n          // console.log(project.indexOf(\"acs_logMonitor\") == -1);\r\n          if (project.indexOf(\"acs_custom\") != -1 || project.indexOf(\"acs_logMonitor\") != -1) {\r\n            var dimensionAcsJson = target.dimensions[0];\r\n            var dimensionAcsObj = {\r\n              \"groupId\": group.toString(),\r\n              \"dimension\": dimensionAcsJson.replace(/\\&/gi, '%26').replace(/\\{/gi, '%7B').replace(/\\}/gi, '%7D')\r\n            };\r\n            dimensions = JSON.stringify(dimensionAcsObj);\r\n          } else {\r\n            //数组对象\r\n            var dimensionArray = [];\r\n            var dimensionJson = target.dimensions;\r\n            var i = dimensionJson.length;\r\n            while (i--) {\r\n              dimensionArray.push({ \"instanceId\": this.getVariableValue(dimensionJson[i]) });\r\n            }\r\n            dimensions = '';\r\n            dimensions = dimensions.concat(JSON.stringify(dimensionArray));\r\n          }\r\n        }\r\n        //dimensions = this.getVariableValue(target.dimensions[0]);\r\n        //拼接查询参数\r\n        var queryConcat = query + \"&Project=\" + project + \"&Metric=\" + metric +\r\n          \"&Period=\" + period + \"&Dimensions=\" + dimensions +\r\n          \"&StartTime=\" + (parseInt(options.range.from._d.getTime())) +\r\n          \"&EndTime=\" + (parseInt(options.range.to._d.getTime()));\r\n        var param = {\r\n          path: queryConcat,\r\n          method: \"GET\"\r\n        };\r\n        // 签名已拼接的待查询URL\r\n        query = this.buildRealUrl(param);\r\n        // console.log(\"查看query的值：\"+query);\r\n        if (_.isEmpty(query)) {\r\n          var d = this.q.defer();\r\n          d.resolve({ data: [] });\r\n          return d.promise;\r\n        }\r\n        // 根据URL发起请求\r\n        return this.backendSrv.datasourceRequest({\r\n          url: query,\r\n          method: 'GET',\r\n          headers: this.headers\r\n        }).then(response => {\r\n          if (response.status == '200' && response.data.Code == '200') {\r\n            // 处理返回结果 (需优化)\r\n            var resResult = [];\r\n            // 解析返回的Datapoints数据集\r\n            var dataDatapoints = angular.fromJson(response.data.Datapoints);\r\n            // console.log(\"长度\"+dataDatapoints.length);\r\n            // console.log(JSON.stringify(dataDatapoints));\r\n            // 处理Grafana所需的target值\r\n            var i = ycol.length;\r\n            // 处理Target组的所需返回结果集\r\n            while (i--) {\r\n              var datapoints = [];\r\n              var ycolTarget = ycol[i];\r\n              // console.log(ycolTarget);\r\n              // console.log(xcol);\r\n              // 封装返回目标的第一层数组值\r\n              _.each(dataDatapoints, Datapoint => {\r\n                let datapoint = [];\r\n                datapoint.push(Datapoint[ycolTarget], Datapoint[xcol]);\r\n                // 封装返回目标的第二层数组值\r\n                datapoints.push(datapoint);\r\n              });\r\n              // 封装返回目标的第三层数组值\r\n              resResult.push({\r\n                \"target\": describe + ycolTarget,\r\n                \"datapoints\": datapoints\r\n              });\r\n              // console.log(JSON.stringify(resResult));\r\n            }\r\n            // 转对象封装\r\n            result = result.concat(typeof resResult == 'string' ? JSON.parse(resResult) : resResult);\r\n          }\r\n        }).catch(function (error) {\r\n          console.log(error);\r\n        });\r\n      });\r\n      requests.push(request);\r\n    })\r\n    // 统一单独处理返回值(可优化)\r\n    return Promise.all(requests.map(p => p.catch(e => e)))\r\n      .then(requests => {\r\n        return { data: result };\r\n      });\r\n  }\r\n\r\n  getVariableValue(name) {\r\n    var variable = this.templateSrv.variables.find(p => (\"$\" + p.name) == name);\r\n    if (variable == null) {\r\n      return name;\r\n    }\r\n    var intVar = parseInt(variable.current.value);\r\n    return isNaN(intVar) ? variable.current.value : intVar;\r\n  }\r\n\r\n  // 测试连接数据源接口\r\n  testDatasource() {\r\n    var param = {\r\n      path: \"/?Action=AccessKeyGet\",\r\n      method: \"GET\"\r\n    };\r\n    return this.backendSrv.datasourceRequest({\r\n      url: this.buildRealUrl(param),\r\n      method: 'GET'\r\n    }).then(response => {\r\n      // console.log(response);\r\n      var data = response.data;\r\n      if (data.ErrorCode == 200 && data.Success == true) {\r\n        return { status: \"success\", message: \"Data source is working\", title: \"Success\" };\r\n      }\r\n    });\r\n  }\r\n\r\n  annotationQuery(options) {\r\n\r\n  }\r\n  metricFindQuery(query, options) {\r\n\r\n    function format(result, type) {\r\n      if (result == null || result.length == 0) {\r\n        return [];\r\n      }\r\n\r\n      if (type == \"group\") {\r\n        return result;\r\n      }\r\n      if (type == \"host\") {\r\n        var d = result.data;\r\n        var arr = [];\r\n        for (var i = 0; i < d.length; i++) {\r\n          arr[i] = { \"text\": d[i].instanceId, \"value\": d[i].instanceId };\r\n        }\r\n        return arr;\r\n      }\r\n      result.forEach(r => { r.text = r.text[0]; r.value = r.value[0]; });\r\n      return result;\r\n      //return [{ \"text\": \"a\", \"value\": \"1\" }, { \"text\": \"b\", \"value\": \"2\" }];\r\n    };\r\n\r\n    if (query == \"project.*\") {\r\n      //project\r\n      return this.getProject().then(result => format(result, \"project\"));\r\n    }\r\n\r\n    if (query == \"group.*\") {\r\n      return this.getGroups().then(result => format(result, \"group\"));\r\n    }\r\n    var pars = query.split(\".\");\r\n    if (pars.length == 4) {\r\n      if (pars[2] == \"host\") {\r\n        var vb = options.variable.templateSrv.variables.find(p => p.name == \"group\");\r\n        return this.getDimensionsByGroup(this.getVariableValue(\"$group\")).then(result => format(result, \"host\"));\r\n      }\r\n    }\r\n  }\r\n\r\n  // 根据阿里监控API文档处理URL签名,做封装调用接口用\r\n  buildRealUrl(param) {\r\n    var signer = new CmsSigner({\r\n      accessKeyId: this.jsonData.cmsAccessKey,\r\n      secretAccessKey: this.jsonData.cmsSecretKey\r\n    }, param);\r\n    signer.addAuthorization();\r\n    return this.basePath + signer.request.path;\r\n  }\r\n\r\n  //将数组处理成Map对象集 \r\n  mapToTextValue(result) {\r\n    return _.map(result, (d, i) => {\r\n      if (d && d.text && d.value) {\r\n        return { text: d.text, value: d.value };\r\n      } else if (_.isObject(d)) {\r\n        return { text: d, value: i };\r\n      }\r\n      return { text: d, value: d };\r\n    });\r\n  }\r\n\r\n  //返回所有的Project TODO等API待优化  \r\n  // QueryProjectMeta的API无自定义监控project、日志监控project，待确认是否拼接\r\n  getProject() {\r\n    var param = {\r\n      path: \"/?Action=QueryProjectMeta&PageNumber=1&PageSize=100\",\r\n      method: \"GET\"\r\n    };\r\n    return this.backendSrv.datasourceRequest({\r\n      url: this.buildRealUrl(param),\r\n      method: 'GET'\r\n    }).then(response => {\r\n      var result = [];\r\n      var data = response.data;\r\n      if (data.ErrorCode == 200 && data.Success == true) {\r\n        // console.log(JSON.stringify(data));\r\n        var projectArray = data.Resources.Resource;\r\n        // console.log(JSON.stringify(projectArray));\r\n        var i = projectArray.length;\r\n        // console.log(i);\r\n        while (i--) {\r\n          var projectInfo = projectArray[i];\r\n          // console.log(projectInfo);\r\n          var project = [];\r\n          project.push(projectInfo.Project);\r\n          result.push(project);\r\n        }\r\n      }\r\n      // console.log(this.jsonData.uid);\r\n      //增加自定义监控、日志监控选项\r\n      var acs_param = {\r\n        path: \"/?Action=AccessKeyGet\",\r\n        method: \"GET\"\r\n      };\r\n      return this.backendSrv.datasourceRequest({\r\n        url: this.buildRealUrl(acs_param),\r\n        method: 'GET'\r\n      }).then(response => {\r\n        var data = response.data;\r\n        if (data.ErrorCode == 200 && data.Success == true) {\r\n          var projectAcsLog = [];\r\n          projectAcsLog.push(\"acs_logMonitor_\" + data.UserId);\r\n          result.push(projectAcsLog);\r\n          var projectAcsCustom = [];\r\n          projectAcsCustom.push(\"acs_customMetric_\" + data.UserId);\r\n          result.push(projectAcsCustom);\r\n        }\r\n        return _.map(result, (d, i) => {\r\n          return { text: d, value: d };\r\n        });\r\n      });\r\n    }).catch(function (error) {\r\n      console.log(error);\r\n      return;\r\n    });\r\n  }\r\n\r\n  //根据Project返回对应的所有的Metrics 无自定义监控project、日志监控project对应的Metrics TODO等API待优化\r\n  getMetrics(project) {\r\n    var param = {\r\n      path: \"/?Action=QueryMetricMeta&PageNumber=1&PageSize=150&Project=\" + project,\r\n      method: \"GET\"\r\n    };\r\n    return this.backendSrv.datasourceRequest({\r\n      url: this.buildRealUrl(param),\r\n      method: 'GET'\r\n    }).then(response => {\r\n      var data = response.data;\r\n      if (data.ErrorCode == 200 && data.Success == true) {\r\n        var result = [];\r\n        // console.log(JSON.stringify(data));\r\n        var resource = data.Resources.Resource;\r\n        // console.log(JSON.stringify(projectArray));\r\n        var i = resource.length;\r\n        // console.log(i);\r\n        while (i--) {\r\n          var resourceInfo = resource[i];\r\n          // console.log(projectInfo);\r\n          var metric = [];\r\n          metric.push(resourceInfo.Metric);\r\n          result.push(metric);\r\n        }\r\n        return _.map(result, (d, i) => {\r\n          return { text: d, value: d };\r\n        });\r\n      }\r\n    }).catch(function (error) {\r\n      console.log(error);\r\n      return;\r\n    });\r\n  }\r\n\r\n  //根据Project及Metrics返回对应的所有的Period 无自定义监控project、日志监控project对应的Period,TODO等API待优化\r\n  getPeriod(project, metric) {\r\n    var param = {\r\n      path: \"/?Action=QueryMetricMeta&PageNumber=1&PageSize=1&Project=\" + project + \"&Metric=\" + metric,\r\n      method: \"GET\"\r\n    };\r\n    return this.backendSrv.datasourceRequest({\r\n      url: this.buildRealUrl(param),\r\n      method: 'GET'\r\n    }).then(response => {\r\n      var data = response.data;\r\n      if (data.ErrorCode == 200 && data.Success == true) {\r\n        var result = [];\r\n        var period = [];\r\n        var resource = data.Resources.Resource;\r\n        if (resource.length == 0 || !resource[0].Periods) {\r\n          return this.mapToTextValue(period);\r\n        }\r\n        period = resource[0].Periods.split(\",\");\r\n        // console.log(period);\r\n        return this.mapToTextValue(period);\r\n      }\r\n    }).catch(function (error) {\r\n      console.log(error);\r\n      return;\r\n    });\r\n  }\r\n\r\n  //根据Project及Metrics返回对应的所有的Statistics，未处理去除已选项 自定义监控无处理\r\n  getStatistics(project, metric, ycol) {\r\n    var param = {\r\n      path: \"/?Action=QueryMetricMeta&PageNumber=1&PageSize=1&Project=\" + project + \"&Metric=\" + metric,\r\n      method: \"GET\"\r\n    };\r\n    return this.backendSrv.datasourceRequest({\r\n      url: this.buildRealUrl(param),\r\n      method: 'GET'\r\n    }).then(response => {\r\n      var data = response.data;\r\n      if (data.ErrorCode == 200 && data.Success == true) {\r\n        var result = [];\r\n        var statistics = [];\r\n        var resource = data.Resources.Resource;\r\n        if (resource.length == 0 || !resource[0].Statistics) {\r\n          return this.mapToTextValue(statistics);\r\n        }\r\n        statistics = resource[0].Statistics.split(\",\");\r\n        return this.mapToTextValue(statistics);\r\n      }\r\n    }).catch(function (error) {\r\n      console.log(error);\r\n      return;\r\n    });\r\n  }\r\n\r\n  //返回所有的Groups\r\n  getGroups() {\r\n    var param = {\r\n      path: \"/?Action=ListMyGroups&PageNumber=1&PageSize=1000\",\r\n      method: \"GET\"\r\n    };\r\n    return this.backendSrv.datasourceRequest({\r\n      url: this.buildRealUrl(param),\r\n      method: 'GET'\r\n    }).then(response => {\r\n      var data = response.data;\r\n      if (data.ErrorCode == 200 && data.Success == true) {\r\n        var result = [];\r\n        var resource = data.Resources.Resource;\r\n        var i = resource.length;\r\n        while (i--) {\r\n          var group = resource[i];\r\n          var groupInfo = [];\r\n          groupInfo.push(group.GroupId, group.GroupName + \" / \" + group.GroupId);\r\n          result.push(groupInfo);\r\n        }\r\n        return _.map(result, (d, i) => {\r\n          return { text: d[1], value: d[0] };\r\n        });\r\n      }\r\n    }).catch(function (error) {\r\n      console.log(error);\r\n      return;\r\n    });\r\n  }\r\n\r\n  //返回所有的Dimensions 自定义监控无处理\r\n  // -- 如果有应用分组Id则根据该值查询该组下所有的Dimensions\r\n  // -- 如果无应用分组Id则根据查询该账户下所有的Dimensions\r\n  getDimensions(project, metric, group, dimensions, period, query) {\r\n    var result = [];\r\n    if (!group || typeof group == 'string') {\r\n      group = 0;\r\n    }\r\n    if (isNaN(parseInt(group))) {\r\n      group = 0;\r\n    }\r\n    if (project.indexOf(\"acs_customMetric\") != -1 || project.indexOf(\"acs_logMonitor\") != -1) {\r\n      return;\r\n    }\r\n    if (group != 0) {\r\n      var param = {\r\n        path: \"/?Action=ListMyGroupInstances&PageNumber=1&PageSize=1000&GroupId=\" + parseInt(group),\r\n        method: \"GET\"\r\n      };\r\n      return this.backendSrv.datasourceRequest({\r\n        url: this.buildRealUrl(param),\r\n        method: 'GET'\r\n      }).then(response => {\r\n        // console.log(JSON.stringify(response));\r\n        var data = response.data;\r\n        if (data.ErrorCode == 200 && data.Success == true) {\r\n          var resource = data.Resources.Resource;\r\n\r\n          var i = resource.length;\r\n          while (i--) {\r\n            var instance = resource[i];\r\n            var instanceInfo = [];\r\n            //判断空对象处理\r\n            if (!instance.InstanceId) {\r\n              continue;\r\n            }\r\n            // 去掉页面已选择实例\r\n            if (_.includes(dimensions, instance.InstanceId)) {\r\n              continue;\r\n            }\r\n            instanceInfo.push(instance.InstanceId);\r\n            result.push(instanceInfo);\r\n          }\r\n          return _.map(result, (d, i) => {\r\n            return { text: d, value: d };\r\n          });\r\n        }\r\n      }).catch(function (error) {\r\n        console.log(error);\r\n        return;\r\n      });\r\n    } else {\r\n      var endTime = new Date().getTime();\r\n      var startTime = endTime - 1 * 60 * 60 * 1000;\r\n      var param = {\r\n        path: \"/?Action=QueryMetricLast&Page=1&Length=1000&Period=\" + period + \"&Project=\"\r\n          + project + \"&Metric=\" + metric + \"&StartTime=\" + startTime + \"&EndTime=\" + endTime,\r\n        method: \"GET\"\r\n      };\r\n      return this.backendSrv.datasourceRequest({\r\n        url: this.buildRealUrl(param),\r\n        method: 'GET'\r\n      }).then(response => {\r\n        var data = response.data;\r\n        // console.log(JSON.stringify(data));\r\n        var datapoints = JSON.parse(data.Datapoints);\r\n        // console.log(JSON.stringify(datapoints));\r\n        var i = datapoints.length;\r\n        if (i > 0) {\r\n          while (i--) {\r\n            var datapoint = datapoints[i];\r\n            var datapointInfo = [];\r\n            //判断空对象处理\r\n            if (!datapoint.instanceId) {\r\n              continue;\r\n            }\r\n            // 去掉页面已选择实例\r\n            if (_.includes(dimensions, datapoint.instanceId)) {\r\n              continue;\r\n            }\r\n            datapointInfo.push(datapoint.instanceId);\r\n            result.push(datapointInfo);\r\n          }\r\n          return _.map(result, (d, i) => {\r\n            return { text: d, value: d };\r\n          });\r\n        }\r\n      }).catch(function (error) {\r\n        console.log(error);\r\n        return;\r\n      });\r\n    }\r\n  }\r\n\r\n  // 根据应用分组Id返回该组下所有的Dimensions \r\n  getDimensionsByGroup(group) {\r\n    var result = [];\r\n    if (!group || typeof group == 'string') {\r\n      group = 0;\r\n    }\r\n    if (isNaN(parseInt(group))) {\r\n      group = 0;\r\n    }\r\n    var param = {\r\n      path: \"/?Action=ListMyGroupInstances&PageNumber=1&PageSize=1000&GroupId=\" + parseInt(group),\r\n      method: \"GET\"\r\n    };\r\n    return this.backendSrv.datasourceRequest({\r\n      url: this.buildRealUrl(param),\r\n      method: 'GET'\r\n    }).then(response => {\r\n      var dimensions = [];\r\n      var data = response.data;\r\n      if (data.ErrorCode == 200 && data.Success == true) {\r\n        var resource = data.Resources.Resource;\r\n        var i = resource.length;\r\n        while (i--) {\r\n          var instance = resource[i];\r\n          dimensions.push({ \"instanceId\": instance.InstanceId });\r\n        }\r\n        result = result.concat(typeof dimensions == 'string' ? JSON.parse(dimensions) : dimensions);\r\n        return { data: result, code: '200' };\r\n      } else {\r\n        return { data: result, code: '400' };\r\n      }\r\n    }).catch(function (error) {\r\n      console.log(error);\r\n      return { data: result, code: '400' };\r\n    });\r\n  }\r\n\r\n  isNotEmpty(obj) { // 判断对象是否为空对象\r\n    for (var name in obj) {\r\n      return true;\r\n    } // 不为空\r\n    return false; // 为空\r\n  }\r\n}"]}