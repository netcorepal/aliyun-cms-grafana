{"version":3,"sources":["../src/datasource.js"],"names":["_","CmsSigner","GenericDatasource","instanceSettings","$q","backendSrv","templateSrv","type","basePath","url","name","jsonData","q","headers","options","requests","promise","Promise","resolve","result","data","targets","forEach","target","project","metric","ycol","xcol","query","dimensions","period","group","request","getDimensionsByGroup","getVariableValue","then","response","code","length","concat","JSON","stringify","indexOf","dimensionAcsJson","dimensionAcsObj","toString","replace","dimensionArray","dimensionJson","Array","isArray","i","pros","queryConcat","parseInt","range","from","_d","getTime","to","push","doQuery","all","param","path","method","buildRealUrl","isEmpty","d","defer","datasourceRequest","status","Code","describe","resResult","dataDatapoints","angular","fromJson","Datapoints","datapoints","ycolTarget","each","datapoint","Datapoint","parse","console","log","catch","error","variable","variables","find","p","intVar","current","value","isNaN","ErrorCode","Success","message","title","format","arr","instanceId","r","text","getProject","getGroups","pars","split","vb","signer","accessKeyId","cmsAccessKey","secretAccessKey","cmsSecretKey","addAuthorization","map","isObject","projectArray","Resources","Resource","projectInfo","Project","acs_param","projectAcsLog","UserId","projectAcsCustom","resource","resourceInfo","Metric","Periods","mapToTextValue","statistics","Statistics","groupInfo","GroupId","GroupName","instance","instanceInfo","InstanceId","includes","endTime","Date","startTime","datapointInfo","obj"],"mappings":"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","file":"datasource.js","sourcesContent":["import _ from \"lodash\";\r\nimport { CmsSigner } from \"./signer.js\";\r\n\r\nexport class GenericDatasource {\r\n  constructor(instanceSettings, $q, backendSrv, templateSrv) {\r\n    this.type = instanceSettings.type;\r\n    this.basePath = instanceSettings.url;\r\n    this.name = instanceSettings.name;\r\n    this.jsonData = instanceSettings.jsonData;\r\n    this.q = $q;\r\n    this.backendSrv = backendSrv;\r\n    this.templateSrv = templateSrv;\r\n    this.headers = { 'Content-Type': 'application/json' };\r\n  }\r\n\r\n  query(options) {\r\n    let requests = []\r\n    let promise = Promise.resolve();\r\n    var result = { data: [] };\r\n    _(options.targets).forEach(target => {\r\n      //非空参数判空处理\r\n      if (!target.project || !target.metric || !target.ycol || !target.xcol) {\r\n        return;\r\n      }\r\n      var project = target.project;\r\n      var metric = target.metric;\r\n\r\n\r\n      var query = \"/?Action=QueryMetricList&Length=2000\";\r\n      var dimensions = \"\";\r\n      var period = target.period;\r\n      var group = target.group\r\n      if (!period) {\r\n        period = '';\r\n      }\r\n      if (!group) {\r\n        group = '';\r\n      }\r\n      //定义Promise元数据\r\n      let request = this.getDimensionsByGroup(this.getVariableValue(group), this.getVariableValue(project)).then(response => {\r\n        // console.log(JSON.stringify(response));\r\n        //处理group--根据GroupId获取该组下的所有实例Id\r\n        if ('200' == response.code && response.data.length > 0) {\r\n          var data = response.data;\r\n          dimensions = dimensions.concat(JSON.stringify(data));\r\n        } else {\r\n          dimensions = '';\r\n        }\r\n        //自定义监控(acs_custom)、日志监控(acs_logMonitor)自动取消分组功能\r\n        if (project.indexOf(\"acs_custom\") == -1 || project.indexOf(\"acs_logMonitor\") == -1) {\r\n          dimensions = '';\r\n        }\r\n      }).then(async () => {\r\n        //GroupId存在的同时,dimensions存在,则dimensions覆盖Group下的所有实例Id，以dimensions为准\r\n        if (target.dimensions.length == 0) {\r\n          dimensions = dimensions;\r\n        } else {\r\n          //自定义监控(acs_custom)、日志监控(acs_logMonitor)处理\r\n          // console.log(project.indexOf(\"acs_custom\") == -1);\r\n          // console.log(project.indexOf(\"acs_logMonitor\") == -1);\r\n          if (project.indexOf(\"acs_custom\") != -1 || project.indexOf(\"acs_logMonitor\") != -1) {\r\n            var dimensionAcsJson = target.dimensions[0];\r\n            var dimensionAcsObj = {\r\n              \"groupId\": group.toString(),\r\n              \"dimension\": dimensionAcsJson.replace(/\\&/gi, '%26').replace(/\\{/gi, '%7B').replace(/\\}/gi, '%7D')\r\n            };\r\n            dimensions = JSON.stringify(dimensionAcsObj);\r\n          } else {\r\n            //数组对象\r\n            var dimensionArray = [];\r\n            var dimensionJson = target.dimensions;\r\n            if (target.dimensions.length == 1 && target.dimensions[0] == \"$host\") {\r\n              dimensionJson = this.getVariableValue(\"$host\");\r\n              dimensionJson = Array.isArray(dimensionJson) ? dimensionJson : [dimensionJson];\r\n            }\r\n            var i = dimensionJson.length;\r\n            var pros = [];\r\n            while (i--) {\r\n              //dimensionArray.push({ \"instanceId\": dimensionJson[i] });\r\n              dimensions = JSON.stringify({ \"instanceId\": dimensionJson[i] });\r\n              var queryConcat = query + \"&Project=\" + project + \"&Metric=\" + metric +\r\n                \"&Period=\" + period + \"&Dimensions=\" + dimensions +\r\n                \"&StartTime=\" + (parseInt(options.range.from._d.getTime())) +\r\n                \"&EndTime=\" + (parseInt(options.range.to._d.getTime()));\r\n              pros.push(this.doQuery(result, target, queryConcat));\r\n            }\r\n            await Promise.all(pros)\r\n          }\r\n        }\r\n      });\r\n      requests.push(request);\r\n    })\r\n    // 统一单独处理返回值(可优化)\r\n    return Promise.all(requests)\r\n      .then(res => {\r\n        return result;\r\n      });\r\n  }\r\n\r\n\r\n  doQuery(result, target, queryConcat) {\r\n    var param = {\r\n      path: queryConcat,\r\n      method: \"GET\"\r\n    };\r\n    // 签名已拼接的待查询URL\r\n    var query = this.buildRealUrl(param);\r\n    // console.log(\"查看query的值：\"+query);\r\n    if (_.isEmpty(query)) {\r\n      var d = this.q.defer();\r\n      d.resolve({ data: [] });\r\n      return d.promise;\r\n    }\r\n    // 根据URL发起请求\r\n    return this.backendSrv.datasourceRequest({\r\n      url: query,\r\n      method: 'GET',\r\n      headers: this.headers\r\n    }).then(response => {\r\n      if (response.status == '200' && response.data.Code == '200') {\r\n        //默认数组\r\n        var ycol = target.ycol;\r\n        var xcol = target.xcol;\r\n        var describe = target.describe;\r\n        if (!describe) {\r\n          describe = '';\r\n        } else {\r\n          describe = describe + \".\";\r\n        }\r\n        // 处理返回结果 (需优化)\r\n        var resResult = [];\r\n        // 解析返回的Datapoints数据集\r\n        var dataDatapoints = angular.fromJson(response.data.Datapoints);\r\n        // console.log(\"长度\"+dataDatapoints.length);\r\n        // console.log(JSON.stringify(dataDatapoints));\r\n        // 处理Grafana所需的target值\r\n        var i = ycol.length;\r\n        // 处理Target组的所需返回结果集\r\n        while (i--) {\r\n          var datapoints = [];\r\n          var ycolTarget = ycol[i];\r\n          // console.log(ycolTarget);\r\n          // console.log(xcol);\r\n          // 封装返回目标的第一层数组值\r\n          _.each(dataDatapoints, Datapoint => {\r\n            let datapoint = [];\r\n            datapoint.push(Datapoint[ycolTarget], Datapoint[xcol]);\r\n            // 封装返回目标的第二层数组值\r\n            datapoints.push(datapoint);\r\n          });\r\n          // 封装返回目标的第三层数组值\r\n          resResult.push({\r\n            \"target\": describe + ycolTarget,\r\n            \"datapoints\": datapoints\r\n          });\r\n          // console.log(JSON.stringify(resResult));\r\n        }\r\n        // 转对象封装\r\n        //return typeof resResult == 'string' ? JSON.parse(resResult) : resResult;\r\n        result.data = result.data.concat(typeof resResult == 'string' ? JSON.parse(resResult) : resResult);\r\n        //return result;\r\n      }else{\r\n        console.log(response.data);\r\n      }\r\n    }).catch(function (error) {\r\n      console.log(error);\r\n    });\r\n  }\r\n\r\n\r\n\r\n  getVariableValue(name) {\r\n    var variable = this.templateSrv.variables.find(p => (\"$\" + p.name) == name);\r\n    if (variable == null) {\r\n      return name;\r\n    }\r\n    var intVar = parseInt(variable.current.value);\r\n    return isNaN(intVar) ? variable.current.value : intVar;\r\n  }\r\n\r\n  // 测试连接数据源接口\r\n  testDatasource() {\r\n    var param = {\r\n      path: \"/?Action=AccessKeyGet\",\r\n      method: \"GET\"\r\n    };\r\n    return this.backendSrv.datasourceRequest({\r\n      url: this.buildRealUrl(param),\r\n      method: 'GET'\r\n    }).then(response => {\r\n      // console.log(response);\r\n      var data = response.data;\r\n      if (data.ErrorCode == 200 && data.Success == true) {\r\n        return { status: \"success\", message: \"Data source is working\", title: \"Success\" };\r\n      }\r\n    });\r\n  }\r\n\r\n  annotationQuery(options) {\r\n\r\n  }\r\n  metricFindQuery(query, options) {\r\n\r\n    function format(result, type) {\r\n      if (result == null || result.length == 0) {\r\n        return [];\r\n      }\r\n\r\n      if (type == \"group\") {\r\n        return result;\r\n      }\r\n      if (type == \"host\") {\r\n        var d = result.data;\r\n        var arr = [];\r\n        for (var i = 0; i < d.length; i++) {\r\n          arr[i] = { \"text\": d[i].instanceId, \"value\": d[i].instanceId };\r\n        }\r\n        return arr;\r\n      }\r\n      result.forEach(r => { r.text = r.text[0]; r.value = r.value[0]; });\r\n      return result;\r\n      //return [{ \"text\": \"a\", \"value\": \"1\" }, { \"text\": \"b\", \"value\": \"2\" }];\r\n    };\r\n\r\n    if (query == \"project.*\") {\r\n      //project\r\n      return this.getProject().then(result => format(result, \"project\"));\r\n    }\r\n\r\n    if (query == \"group.*\") {\r\n      return this.getGroups().then(result => format(result, \"group\"));\r\n    }\r\n    var pars = query.split(\".\");\r\n    if (pars.length == 4) {\r\n      if (pars[2] == \"host\") {\r\n        var vb = options.variable.templateSrv.variables.find(p => p.name == \"group\");\r\n        return this.getDimensionsByGroup(this.getVariableValue(\"$group\")).then(result => format(result, \"host\"));\r\n      }\r\n    }\r\n  }\r\n\r\n  // 根据阿里监控API文档处理URL签名,做封装调用接口用\r\n  buildRealUrl(param) {\r\n    var signer = new CmsSigner({\r\n      accessKeyId: this.jsonData.cmsAccessKey,\r\n      secretAccessKey: this.jsonData.cmsSecretKey\r\n    }, param);\r\n    signer.addAuthorization();\r\n    return this.basePath + signer.request.path;\r\n  }\r\n\r\n  //将数组处理成Map对象集 \r\n  mapToTextValue(result) {\r\n    return _.map(result, (d, i) => {\r\n      if (d && d.text && d.value) {\r\n        return { text: d.text, value: d.value };\r\n      } else if (_.isObject(d)) {\r\n        return { text: d, value: i };\r\n      }\r\n      return { text: d, value: d };\r\n    });\r\n  }\r\n\r\n  //返回所有的Project TODO等API待优化  \r\n  // QueryProjectMeta的API无自定义监控project、日志监控project，待确认是否拼接\r\n  getProject() {\r\n    var param = {\r\n      path: \"/?Action=QueryProjectMeta&PageNumber=1&PageSize=100\",\r\n      method: \"GET\"\r\n    };\r\n    return this.backendSrv.datasourceRequest({\r\n      url: this.buildRealUrl(param),\r\n      method: 'GET'\r\n    }).then(response => {\r\n      var result = [];\r\n      var data = response.data;\r\n      if (data.ErrorCode == 200 && data.Success == true) {\r\n        // console.log(JSON.stringify(data));\r\n        var projectArray = data.Resources.Resource;\r\n        // console.log(JSON.stringify(projectArray));\r\n        var i = projectArray.length;\r\n        // console.log(i);\r\n        while (i--) {\r\n          var projectInfo = projectArray[i];\r\n          // console.log(projectInfo);\r\n          var project = [];\r\n          project.push(projectInfo.Project);\r\n          result.push(project);\r\n        }\r\n      }\r\n      // console.log(this.jsonData.uid);\r\n      //增加自定义监控、日志监控选项\r\n      var acs_param = {\r\n        path: \"/?Action=AccessKeyGet\",\r\n        method: \"GET\"\r\n      };\r\n      return this.backendSrv.datasourceRequest({\r\n        url: this.buildRealUrl(acs_param),\r\n        method: 'GET'\r\n      }).then(response => {\r\n        var data = response.data;\r\n        if (data.ErrorCode == 200 && data.Success == true) {\r\n          var projectAcsLog = [];\r\n          projectAcsLog.push(\"acs_logMonitor_\" + data.UserId);\r\n          result.push(projectAcsLog);\r\n          var projectAcsCustom = [];\r\n          projectAcsCustom.push(\"acs_customMetric_\" + data.UserId);\r\n          result.push(projectAcsCustom);\r\n        }\r\n        return _.map(result, (d, i) => {\r\n          return { text: d, value: d };\r\n        });\r\n      });\r\n    }).catch(function (error) {\r\n      console.log(error);\r\n      return;\r\n    });\r\n  }\r\n\r\n  //根据Project返回对应的所有的Metrics 无自定义监控project、日志监控project对应的Metrics TODO等API待优化\r\n  getMetrics(project) {\r\n    var param = {\r\n      path: \"/?Action=QueryMetricMeta&PageNumber=1&PageSize=150&Project=\" + project,\r\n      method: \"GET\"\r\n    };\r\n    return this.backendSrv.datasourceRequest({\r\n      url: this.buildRealUrl(param),\r\n      method: 'GET'\r\n    }).then(response => {\r\n      var data = response.data;\r\n      if (data.ErrorCode == 200 && data.Success == true) {\r\n        var result = [];\r\n        // console.log(JSON.stringify(data));\r\n        var resource = data.Resources.Resource;\r\n        // console.log(JSON.stringify(projectArray));\r\n        var i = resource.length;\r\n        // console.log(i);\r\n        while (i--) {\r\n          var resourceInfo = resource[i];\r\n          // console.log(projectInfo);\r\n          var metric = [];\r\n          metric.push(resourceInfo.Metric);\r\n          result.push(metric);\r\n        }\r\n        return _.map(result, (d, i) => {\r\n          return { text: d, value: d };\r\n        });\r\n      }\r\n    }).catch(function (error) {\r\n      console.log(error);\r\n      return;\r\n    });\r\n  }\r\n\r\n  //根据Project及Metrics返回对应的所有的Period 无自定义监控project、日志监控project对应的Period,TODO等API待优化\r\n  getPeriod(project, metric) {\r\n    var param = {\r\n      path: \"/?Action=QueryMetricMeta&PageNumber=1&PageSize=1&Project=\" + project + \"&Metric=\" + metric,\r\n      method: \"GET\"\r\n    };\r\n    return this.backendSrv.datasourceRequest({\r\n      url: this.buildRealUrl(param),\r\n      method: 'GET'\r\n    }).then(response => {\r\n      var data = response.data;\r\n      if (data.ErrorCode == 200 && data.Success == true) {\r\n        var result = [];\r\n        var period = [];\r\n        var resource = data.Resources.Resource;\r\n        if (resource.length == 0 || !resource[0].Periods) {\r\n          return this.mapToTextValue(period);\r\n        }\r\n        period = resource[0].Periods.split(\",\");\r\n        // console.log(period);\r\n        return this.mapToTextValue(period);\r\n      }\r\n    }).catch(function (error) {\r\n      console.log(error);\r\n      return;\r\n    });\r\n  }\r\n\r\n  //根据Project及Metrics返回对应的所有的Statistics，未处理去除已选项 自定义监控无处理\r\n  getStatistics(project, metric, ycol) {\r\n    var param = {\r\n      path: \"/?Action=QueryMetricMeta&PageNumber=1&PageSize=1&Project=\" + project + \"&Metric=\" + metric,\r\n      method: \"GET\"\r\n    };\r\n    return this.backendSrv.datasourceRequest({\r\n      url: this.buildRealUrl(param),\r\n      method: 'GET'\r\n    }).then(response => {\r\n      var data = response.data;\r\n      if (data.ErrorCode == 200 && data.Success == true) {\r\n        var result = [];\r\n        var statistics = [];\r\n        var resource = data.Resources.Resource;\r\n        if (resource.length == 0 || !resource[0].Statistics) {\r\n          return this.mapToTextValue(statistics);\r\n        }\r\n        statistics = resource[0].Statistics.split(\",\");\r\n        return this.mapToTextValue(statistics);\r\n      }\r\n    }).catch(function (error) {\r\n      console.log(error);\r\n      return;\r\n    });\r\n  }\r\n\r\n  //返回所有的Groups\r\n  getGroups() {\r\n    var param = {\r\n      path: \"/?Action=ListMyGroups&PageNumber=1&PageSize=1000\",\r\n      method: \"GET\"\r\n    };\r\n    return this.backendSrv.datasourceRequest({\r\n      url: this.buildRealUrl(param),\r\n      method: 'GET'\r\n    }).then(response => {\r\n      var data = response.data;\r\n      if (data.ErrorCode == 200 && data.Success == true) {\r\n        var result = [];\r\n        var resource = data.Resources.Resource;\r\n        var i = resource.length;\r\n        while (i--) {\r\n          var group = resource[i];\r\n          var groupInfo = [];\r\n          groupInfo.push(group.GroupId, group.GroupName + \" / \" + group.GroupId);\r\n          result.push(groupInfo);\r\n        }\r\n        return _.map(result, (d, i) => {\r\n          return { text: d[1], value: d[0] };\r\n        });\r\n      }\r\n    }).catch(function (error) {\r\n      console.log(error);\r\n      return;\r\n    });\r\n  }\r\n\r\n  //返回所有的Dimensions 自定义监控无处理\r\n  // -- 如果有应用分组Id则根据该值查询该组下所有的Dimensions\r\n  // -- 如果无应用分组Id则根据查询该账户下所有的Dimensions\r\n  getDimensions(project, metric, group, dimensions, period, query) {\r\n    var result = [];\r\n    if (!group || typeof group == 'string') {\r\n      group = 0;\r\n    }\r\n    if (isNaN(parseInt(group))) {\r\n      group = 0;\r\n    }\r\n    if (project.indexOf(\"acs_customMetric\") != -1 || project.indexOf(\"acs_logMonitor\") != -1) {\r\n      return;\r\n    }\r\n    if (group != 0) {\r\n      var param = {\r\n        path: \"/?Action=ListMyGroupInstances&PageNumber=1&PageSize=1000&GroupId=\" + parseInt(group),\r\n        method: \"GET\"\r\n      };\r\n      return this.backendSrv.datasourceRequest({\r\n        url: this.buildRealUrl(param),\r\n        method: 'GET'\r\n      }).then(response => {\r\n        // console.log(JSON.stringify(response));\r\n        var data = response.data;\r\n        if (data.ErrorCode == 200 && data.Success == true) {\r\n          var resource = data.Resources.Resource;\r\n\r\n          var i = resource.length;\r\n          while (i--) {\r\n            var instance = resource[i];\r\n            var instanceInfo = [];\r\n            //判断空对象处理\r\n            if (!instance.InstanceId) {\r\n              continue;\r\n            }\r\n            // 去掉页面已选择实例\r\n            if (_.includes(dimensions, instance.InstanceId)) {\r\n              continue;\r\n            }\r\n            instanceInfo.push(instance.InstanceId);\r\n            result.push(instanceInfo);\r\n          }\r\n          return _.map(result, (d, i) => {\r\n            return { text: d, value: d };\r\n          });\r\n        }\r\n      }).catch(function (error) {\r\n        console.log(error);\r\n        return;\r\n      });\r\n    } else {\r\n      var endTime = new Date().getTime();\r\n      var startTime = endTime - 1 * 60 * 60 * 1000;\r\n      var param = {\r\n        path: \"/?Action=QueryMetricLast&Page=1&Length=1000&Period=\" + period + \"&Project=\"\r\n          + project + \"&Metric=\" + metric + \"&StartTime=\" + startTime + \"&EndTime=\" + endTime,\r\n        method: \"GET\"\r\n      };\r\n      return this.backendSrv.datasourceRequest({\r\n        url: this.buildRealUrl(param),\r\n        method: 'GET'\r\n      }).then(response => {\r\n        var data = response.data;\r\n        // console.log(JSON.stringify(data));\r\n        var datapoints = JSON.parse(data.Datapoints);\r\n        // console.log(JSON.stringify(datapoints));\r\n        var i = datapoints.length;\r\n        if (i > 0) {\r\n          while (i--) {\r\n            var datapoint = datapoints[i];\r\n            var datapointInfo = [];\r\n            //判断空对象处理\r\n            if (!datapoint.instanceId) {\r\n              continue;\r\n            }\r\n            // 去掉页面已选择实例\r\n            if (_.includes(dimensions, datapoint.instanceId)) {\r\n              continue;\r\n            }\r\n            datapointInfo.push(datapoint.instanceId);\r\n            result.push(datapointInfo);\r\n          }\r\n          return _.map(result, (d, i) => {\r\n            return { text: d, value: d };\r\n          });\r\n        }\r\n      }).catch(function (error) {\r\n        console.log(error);\r\n        return;\r\n      });\r\n    }\r\n  }\r\n\r\n  // 根据应用分组Id返回该组下所有的Dimensions \r\n  getDimensionsByGroup(group) {\r\n    var result = [];\r\n    if (!group || typeof group == 'string') {\r\n      group = 0;\r\n    }\r\n    if (isNaN(parseInt(group))) {\r\n      group = 0;\r\n    }\r\n    var param = {\r\n      path: \"/?Action=ListMyGroupInstances&PageNumber=1&PageSize=1000&GroupId=\" + parseInt(group),\r\n      method: \"GET\"\r\n    };\r\n    return this.backendSrv.datasourceRequest({\r\n      url: this.buildRealUrl(param),\r\n      method: 'GET'\r\n    }).then(response => {\r\n      var dimensions = [];\r\n      var data = response.data;\r\n      if (data.ErrorCode == 200 && data.Success == true) {\r\n        var resource = data.Resources.Resource;\r\n        var i = resource.length;\r\n        while (i--) {\r\n          var instance = resource[i];\r\n          dimensions.push({ \"instanceId\": instance.InstanceId });\r\n        }\r\n        result = result.concat(typeof dimensions == 'string' ? JSON.parse(dimensions) : dimensions);\r\n        return { data: result, code: '200' };\r\n      } else {\r\n        return { data: result, code: '400' };\r\n      }\r\n    }).catch(function (error) {\r\n      console.log(error);\r\n      return { data: result, code: '400' };\r\n    });\r\n  }\r\n\r\n  isNotEmpty(obj) { // 判断对象是否为空对象\r\n    for (var name in obj) {\r\n      return true;\r\n    } // 不为空\r\n    return false; // 为空\r\n  }\r\n}"]}